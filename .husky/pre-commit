#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Check for deletions in staged changes
DELETIONS=$(git diff --cached --name-status | grep -c "^D" || true)

if [ "$DELETIONS" -gt 0 ]; then
    # Check if commit message contains ALLOW-DELETE
    COMMIT_MSG=$(cat .git/COMMIT_EDITMSG 2>/dev/null || echo "")
    if ! echo "$COMMIT_MSG" | grep -q "ALLOW-DELETE"; then
        echo "âŒ BLOCKED: Commit contains $DELETIONS file deletion(s)"
        echo "ğŸ’¡ To allow deletions, include 'ALLOW-DELETE' in your commit message"
        echo "ğŸ“ Example: git commit -m 'refactor: remove unused files ALLOW-DELETE'"
        echo ""
        echo "ğŸ”’ This is a safety measure to prevent accidental file deletions"
        exit 1
    else
        echo "âœ… Deletions allowed: Commit message contains 'ALLOW-DELETE'"
    fi
fi

# Run existing validation scripts
echo "ğŸ” Running validation scripts..."

# Check entry point
if npm run check:entry; then
    echo "âœ… Entry point check passed"
else
    echo "âŒ Entry point check failed"
    exit 1
fi

# Check SCREENS_MAP.md
if npm run check:screens-map; then
    echo "âœ… SCREENS_MAP.md check passed"
else
    echo "âŒ SCREENS_MAP.md check failed"
    exit 1
fi

# Check for legacy files and emoji icons
if node scripts/check-legacy.js; then
    echo "âœ… Legacy check passed"
else
    echo "âŒ Legacy check failed"
    exit 1
fi

# Validate screens
if npm run validate:screens; then
    echo "âœ… Screen validation passed"
else
    echo "âŒ Screen validation failed"
    exit 1
fi

# Run linting
if npm run lint -- --fix; then
    echo "âœ… Linting passed"
else
    echo "âŒ Linting failed"
    exit 1
fi

# Run type checking
if npm run typecheck; then
    echo "âœ… Type checking passed"
else
    echo "âŒ Type checking failed"
    exit 1
fi

echo "âœ… All pre-commit checks passed"
